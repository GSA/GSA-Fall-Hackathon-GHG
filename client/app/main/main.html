<div ng-include="'components/navbar/navbar.html'"></div>

<script>
  selectedAgency = null;

  function loadAgencies() {
    $.ajax({
      url: "/getAgencies",
      context: document.body
    }).done(function(data) {
      if(selectedAgency) {
        selectedAgency.destroy();
      }

      selectedAgency = $('#selectedAgency').selectize({
        options: data,
        labelField: 'agyName',
        valueField: 'agyAbbrev',
        searchField: 'agyName',
        onChange: function(agency) { agencySelected(agency) }
      })[0].selectize;
    });

    function agencySelected(agency){
      // GET VEHICLE STATS

      $.ajax({
        url: "/getVehicleStats/" + agency,
        context: document.body
      }).done(function(data) {

        var series = [{
          name: 'Donations Received',
          data: data.donations,
          pointPlacement: 'on'
        }, {
          name: 'Donations Requested',
          data: data.requestedDonations,
          pointPlacement: 'on'
        }];

        renderPieChart('vehiclePieChart', data.agyName[0]);
      });

      // GET

      $.ajax({
        url: "/getVehicleStats/" + agency,
        context: document.body
      }).done(function(data) {

        var series = [{
          name: 'Donations Received',
          data: data.donations,
          pointPlacement: 'on'
        }, {
          name: 'Donations Requested',
          data: data.requestedDonations,
          pointPlacement: 'on'
        }];
      });

      $('#initialGraphs').show();
    }
  }

  function renderPieChart(id, agency){
    $('#'+id).highcharts({
      chart: {
        type: 'pie',
        options3d: {
          enabled: true,
          alpha: 45,
          beta: 0
        }
      },
      title: {
        text: 'Vehicles for ' + agency
      },
      tooltip: {
        pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
      },
      plotOptions: {
        pie: {
          allowPointSelect: true,
          cursor: 'pointer',
          depth: 35,
          dataLabels: {
            enabled: true,
            format: '{point.name}'
          }
        }
      },
      series: [{
        type: 'pie',
        name: 'Browser share',
        data: [
          ['Firefox',   45.0],
          ['IE',       26.8],
          {
            name: 'Chrome',
            y: 12.8,
            sliced: true,
            selected: true
          },
          ['Safari',    8.5],
          ['Opera',     6.2],
          ['Others',   0.7]
        ]
      }]
    });
  }
</script>

<header class="hero-unit" id="banner">
  <div class="container">
    <h1>GHG Quick Look Tool</h1>
    <p class="lead">Which government agency are you interested in?</p>
    <div class="col-md-offset-3 col-md-6">
      <select id="selectedAgency" placeholder="Type an agency name"></select>
    </div>
    <script>loadAgencies();</script>
  </div>
</header>

<div class="container" style="display:none;">
  <div class="row" id="initialGraphs">
    <div class="col-md-6">
      <h1 class="page-header"></h1>
      <div id="vehiclePieChart"></div>
    </div>
    <div class="col-md-6">
      <h1 class="page-header"></h1>
      <div id="emissionsBarChart"></div>
    </div>
  </div>
</div>

<footer class="footer">
  <div class="container">
      <p>Angular Fullstack v2.1.1 |
        <a href="https://twitter.com/tyhenkel">@tyhenkel</a> |
         <a href="https://github.com/DaftMonk/generator-angular-fullstack/issues?state=open">Issues</a></p>
  </div>
</footer>
